## ğŸ“ ë°°ê²½ ì§€ì‹ (Context)

Stage 1ì€ íŒŒì¼ëª…ì—ì„œ ë©”íƒ€ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ê³ , ì›¹ ê²€ìƒ‰ìœ¼ë¡œ ì¶”ê°€ ì •ë³´ë¥¼ ë³´ê°•í•˜ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤. Gemini APIë¡œ ì œëª©/ì‘ê°€/ì¥ë¥´ ë“±ì„ ì¶”ì¶œí•˜ê³ , Perplexity APIë¡œ ë³„ì /í‘œì§€ URLì„ ê²€ìƒ‰í•©ë‹ˆë‹¤.

## ğŸ¯ ëª©í‘œ (Goal)

1. Gemini API í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„ (ë©”íƒ€ë°ì´í„° ì¶”ì¶œ)
2. Perplexity API í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„ (ì›¹ ê²€ìƒ‰, í‘œì§€ ë‹¤ìš´ë¡œë“œ)
3. Rate limiting ë° ì‘ë‹µ ìºì‹±
4. DB ì €ì¥ (novels, novel_extra í…Œì´ë¸”)
5. ì—ëŸ¬ ì²˜ë¦¬ ë° ë°°ì¹˜ ì²˜ë¦¬

## ğŸ› ï¸ ê¸°ìˆ ì  ê³„íš (Technical Plan)

### êµ¬í˜„ëœ ëª¨ë“ˆ

#### 1. `src/novel_total_processor/ai/gemini_client.py`
- **GeminiClient í´ë˜ìŠ¤**:
  - `extract_metadata_from_filename()`: íŒŒì¼ëª… â†’ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
  - `_call_api()`: Gemini API í˜¸ì¶œ (tenacity ì¬ì‹œë„)
  - Rate limiting: 60 RPM (ì„¤ì • ê°€ëŠ¥)
  - JSON ìºì‹±: `data/cache/ai_meta/{hash}.json`
  - ë°°ì¹˜ ì²˜ë¦¬: `extract_batch()`

- **ì¶”ì¶œ ì •ë³´**:
  - ì œëª©, ì‘ê°€, ì¥ë¥´, íƒœê·¸, ìƒíƒœ, í™”ìˆ˜ ë²”ìœ„

#### 2. `src/novel_total_processor/ai/perplexity_client.py`
- **PerplexityClient í´ë˜ìŠ¤**:
  - `search()`: Search API ì›¹ ê²€ìƒ‰
  - `search_novel_info()`: ì†Œì„¤ ì •ë³´ ê²€ìƒ‰
  - `download_cover()`: í‘œì§€ ë‹¤ìš´ë¡œë“œ (Pillow ë¦¬ì‚¬ì´ì¦ˆ 600x900)
  - Rate limiting: 60 RPM
  - í•œêµ­ì–´ ìš°ì„  ê²€ìƒ‰: `search_language_filter=["ko"]`

#### 3. `src/novel_total_processor/stages/stage1_metadata.py`
- **MetadataCollector í´ë˜ìŠ¤**:
  - `get_pending_files()`: Stage 1 ëŒ€ê¸° íŒŒì¼ ì¡°íšŒ
  - `process_file()`: Gemini + Perplexity í†µí•© ì²˜ë¦¬
  - `_save_to_db()`: novels + novel_extra ì €ì¥
  - `_mark_error()`: ì—ëŸ¬ ê¸°ë¡
  - `run()`: ì „ì²´ Stage 1 ì‹¤í–‰

### í™˜ê²½ë³€ìˆ˜ ì„¤ì • í•„ìš”
```bash
export GEMINI_API_KEY="your_gemini_api_key"
export PERPLEXITY_API_KEY="your_perplexity_api_key"  # ì„ íƒ
```

### í…ŒìŠ¤íŠ¸ ë°©ë²•
```bash
python test_stage1.py  # ì²˜ìŒ 10ê°œ íŒŒì¼ í…ŒìŠ¤íŠ¸
```

## âœ… ì™„ë£Œ ì¡°ê±´ (Definition of Done)

- [x] GeminiClient êµ¬í˜„ (ë©”íƒ€ë°ì´í„° ì¶”ì¶œ, rate limiting, ìºì‹±)
- [x] PerplexityClient êµ¬í˜„ (ì›¹ ê²€ìƒ‰, í‘œì§€ ë‹¤ìš´ë¡œë“œ)
- [x] MetadataCollector êµ¬í˜„ (DB ì €ì¥, ì—ëŸ¬ ì²˜ë¦¬)
- [x] ë°°ì¹˜ ì²˜ë¦¬ ë¡œì§ êµ¬í˜„
- [x] í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±

## ğŸ“ ì§„í–‰ ê¸°ë¡

| ë‚ ì§œ | ë‚´ìš© |
|:---|:---|
| 2026-02-12 | ì´ìŠˆ ìƒì„± |
| 2026-02-12 | Gemini/Perplexity í´ë¼ì´ì–¸íŠ¸ + Stage 1 êµ¬í˜„ ì™„ë£Œ |
