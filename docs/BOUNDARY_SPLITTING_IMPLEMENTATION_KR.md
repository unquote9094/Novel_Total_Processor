# 스테이지 4 고급 파이프라인 - 경계 기반 분할 구현 (Stage 4 Advanced Pipeline - Boundary-Based Splitting)

## 개요 (Overview)
이 구현은 스테이지 4의 고급 에스컬레이션 파이프라인에서 기존의 허용적 정규식 패턴(Permissive Regex) 기반 분할 방식을 **직접적인 경계 기반 분할(Boundary-Based Splitting)** 방식으로 교체합니다. 이를 통해 파이프라인이 정확히 예상된 수의 챕터를 생성하도록 보장합니다.

## 문제 (Problem)
이전의 스테이지 4 고급 에스컬레이션 파이프라인은 다음과 같은 한계가 있었습니다:
1. 전역 최적화를 통해 최적의 경계를 선택함.
2. 선택된 경계에서 제목 줄(Title lines)을 추출함.
3. 허용적 패턴(`.+`)과 추출된 제목 후보군을 사용하여 `splitter.split()`을 호출함.
4. 하지만 패턴 기반 방식은 간혹 경계 수와 일치하지 않는 챕터 수를 생성할 위험이 있었습니다.

## 해결책 (Solution)

### 1. 신규 `split_by_boundaries()` 메서드 도입
`Splitter` 클래스에 다음과 같은 기능을 가진 새 메서드를 추가했습니다:
- `line_num`과 `text` 필드를 가진 경계(Boundary) 딕셔너리 리스트를 입력받음.
- 정규식 패턴 매칭을 **완전히 건너뛰고** 라인 번호 위치를 사용하여 파일을 직접 분할함.
- 항상 정확히 경계 리스트의 길이(`len(boundaries)`)만큼의 챕터를 생성함.
- 분할 전 모든 경계값의 유효성을 검증하고, 문제가 있을 경우 명확한 에러 메시지와 함께 즉시 중단(Fail-fast)함.

### 2. 스테이지 4 파이프라인 업데이트
`_advanced_escalation_pipeline()`을 다음과 같이 수정했습니다:
- 분할 시작 전, 경계 수가 예상 화수와 일치하는지 먼저 검증함.
- 모든 경계가 필수 필드를 가지고 있는지 확인함.
- 패턴 기반의 `split()` 대신 신규 `split_by_boundaries()`를 호출함.
- 로그 출력 개선: 경계 수, 포맷, 그리고 최종 결과(Created N chapters)를 간결하게 표시.

## 주요 특징 (Key Features)

1. **정확한 화수 보장**: 모든 경계에 대해 반드시 챕터를 생성하므로 화수 불일치가 발생하지 않습니다.
2. **사전 검증 (Fail-Fast)**: 라인 번호가 파일 범위를 벗어나거나 제목이 비어 있는 등의 문제를 분할 전에 잡아냅니다.
3. **효율성**: 정규식 컴파일이나 복잡한 패턴 매칭 과정이 없어 속도가 빠르고 예측 가능합니다.
4. **간결한 로깅**: 실행 과정과 결과를 한눈에 파악할 수 있도록 로깅을 정비했습니다.

## 테스트 결과 (Testing)
- **`test_boundary_splitting.py`**: 라인 번호 기반의 직접 분할 정확도 검증.
- **`test_boundary_validation.py`**: 입력값 유효성 검사 및 에러 핸들링 검증.
- **`test_stage4_pipeline.py`**: 전체 스테이지 4 파이프라인 통합 테스트.
- ✅ 모든 테스트에서 정규식 없이 정확한 화수 생성을 확인했습니다 (100% 통과).

## 결론 (Conclusion)
이제 고급 에스컬레이션 모드에서 시스템은 더 이상 패턴 매칭의 불확실성에 의존하지 않습니다. 직접적인 라인 번호 분할 방식을 통해 어떠한 난해한 소설이라도 목표한 화수를 100% 정합성 있게 추출할 수 있는 견고한 토대를 마련했습니다.
