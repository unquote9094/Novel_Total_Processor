# 📄 HANDOVER: Stage 4 Pattern Recognition Regression & Flooding Issue (#21)

## 📌 현재 상황 요약
- **작업 목표**: Stage 4의 패턴 인식 정확도 개선 및 화수 누락(317/370) 해결.
- **현재 상태**: **치명적 퇴보(Regression)** 발생. 317개 찾던 패턴이 30개 미만으로 떨어졌으며, 본문 대화문을 챕터로 인식하는 **폭주(Flooding)** 현상 발생.

## ⚠️ 핵심 문제점 (결함 분석)
1. **AI 가이드라인 상실**: "선입견 방지"를 위해 프롬프트에서 일반적 예시를 제거했으나, 이로 인해 AI가 소설의 구조 자체를 파악 못 함.
2. **공격적 패턴 완화**: `_relax_number_requirement` 로직이 숫자를 `\d*`(생략 가능)로 바꾸면서 "전화", "화장실" 등 본문의 "화"가 포함된 모든 단어를 챕터로 오인함.
3. **무한 루프**: 부족한 화수를 채우려고 AI를 계속 호출하는 `Plan C` 단계에 가드라인이 없어 로그 및 비용 폭주 발생.

## 🛠 수정 내역 (진행 중 중단)
- [x] AI 프롬프트 개편 (구조 중심 분석 유도 - 하지만 효과 미비)
- [x] 정규식 추출 로직 강화
- [/] 폭주 방지 가드라인 도입 (1.5배 초과 시 리젝션) - *일부 단계에만 적용됨*
- [/] AI 호출 횟수 캡핑 (Max 5회) - *Level 3 단계에 적용*

## ⏭ 다음 작업자 가이드 (Next Steps)
1. **AI 의존도 축소**: AI에게 패턴 작문을 맡기기 전, 실제 소설의 `<...>` 등 구조적 특징을 `Sampler`가 소품종 대량 검증하여 후보를 압축해야 함.
2. **수동 패턴 보강**: AI가 만든 패턴에 무조건 `^` (행 시작) 앵커를 강제하고, `\d*` 같은 위험한 수량자 사용을 코드 레벨에서 금지해야 함.
3. **Plan C 안정화**: `_run_adaptive_retry_v3` 루프 내에 화수 폭주 체크 로직을 반드시 삽입하여 루프 탈출 보장 필요.
4. **회귀 테스트**: 현재 30개로 떨어진 탐지 숫자를 다시 317개 이상으로 복구하는 것이 최우선 과제.

---
**기록일**: 2026-02-15
**담당**: Antigravity (Antigravity-C4)
