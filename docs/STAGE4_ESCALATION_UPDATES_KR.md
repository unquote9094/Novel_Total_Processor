# 스테이지 4 에스컬레이션 임계값 업데이트 - 요약 (Stage 4 Escalation Threshold Updates - Summary)

## 개요 (Overview)
이 PR은 스테이지 4 챕터 분할 기능에 대해 더욱 엄격해진 에스컬레이션 임계값과 간격 재시도 제한을 구현합니다. 이를 통해 시스템은 패턴 보정 문제에 더 빠르게 반응하고 효율적으로 동작하게 됩니다.

## 충족된 요구 사항 (Requirements Met)

### ✅ 1. 3회 연속 정체 시 에스컬레이션 강제
**요구 사항**: +/-1 또는 +/-2 정도의 미세한 화수 변동을 '정체(Stagnant)'로 간주하여, 3회 시도 임계값이 안정적으로 작동하도록 함.

**구현 내용**:
- `stage4_splitter.py`의 `_is_stagnant()` 메서드를 업데이트하여 `최대값 - 최소값 <= 2`인지 확인.
- 단순 일치 여부 대신 오차 허용(Tolerance) 기반의 확인 방식으로 변경.
- 이제 `[85, 87, 85]`, `[10, 11, 10]`, `[100, 100, 100]`과 같은 패턴에서 에스컬레이션이 트리거됨.
- `[10, 15, 20]`, `[10, 10, 14]`와 같이 유의미한 변화가 있는 경우는 계속 재시도함.

### ✅ 2. 2회 연속 패턴 보강 거절 시 에스컬레이션 트리거
**요구 사항**: 패턴 보강이 2회 연속으로 거절("보강 패턴 거절")될 경우, 즉시 고급 파이프라인 에스컬레이션을 트리거함.

**구현 내용**:
- `refine_pattern_with_goal_v3()`가 `(패턴, 거절_횟수)` 튜플을 반환하도록 수정.
- 재시도 루프 내에서 `consecutive_rejection_count` 추적 로직 추가.
- 거절 시 증가, 성공 시 0으로 초기화.
- `consecutive_rejection_count >= 2`인 경우 에스컬레이션 트리거.
- 로그에 "🚨 Escalation reason: Consecutive pattern refinement rejections" 명시.

### ✅ 3. 간격 기반 패턴 보강을 최대 3개로 제한
**요구 사항**: AI 호출을 억제하기 위해 `MAX_GAPS_TO_ANALYZE=3`을 일관되게 사용.

**구현 내용**:
- `refine_pattern_with_goal_v3()`에 기본값 3을 갖는 `max_gaps` 파라미터 추가.
- 간격 분석 루프를 `for gap in gaps[:max_gaps]:`로 변경하여 상위 3개만 처리.
- 로그 출력 강화: "📊 Gap 분석 제한: X/Y gaps (MAX_GAPS_TO_ANALYZE=3)".

### ✅ 4. 간결하고 명확한 에스컬레이션 사유 로깅
**요구 사항**: 왜 에스컬레이션이 발생했는지(정체, 연속 거절, 간격 제한 등) 명확하게 로깅.

**구현 내용**:
- 정체 로깅: 사유(Stagnation detected)와 최근 N회의 화수 변화 이력 표시.
- 거절 로깅: 사유(Consecutive pattern refinement rejections)와 연속 거절 횟수 표시.
- 간격 제한 로깅: 분석된 간격 수와 전체 간격 수 표시.

## 테스트 결과 (Testing)
- ✅ **정체 감지 테스트**: 동일 화수(10, 10, 10), +/-1 변동(10, 11, 10), +/-2 변동(85, 87, 85) 등 모든 시나리오 통과.
- ✅ **유의미한 변화 테스트**: 화수 변화가 2를 초과하는 경우 에스컬레이션되지 않음을 확인.
- ✅ **반환 타입 검증**: `refine_pattern_with_goal_v3()`가 올바른 튜플 타입을 반환함을 확인.

## 수정된 파일 (Files Modified)
1. `src/novel_total_processor/stages/stage4_splitter.py`: `_is_stagnant()` 로직 개선, 연속 거절 추적 및 로깅 강화.
2. `src/novel_total_processor/stages/pattern_manager.py`: 반환 타입 변경, 간격 분석 수(max_gaps) 제한 적용.
3. `test_stage4_fixes.py`: 새로운 정체 감지 시나리오 및 테스트 케이스 추가.

## 영향 분석 (Impact)
- **성능**: 간격 분석이 최대 3개로 제한되어 AI 호출 수 감소. 정체 시 조기 에스컬레이션으로 전체 처리 시간 단축.
- **신뢰성**: 미세 변동을 정체로 정확히 인지하여 고급 분석 모드로의 전환 시점이 최적화됨.
- **가독성**: 강화된 로그를 통해 에스컬레이션 발생 원인을 즉시 파악 가능.

## 결론 (Conclusion)
모든 요구 사항이 성공적으로 구현되었습니다. 이제 시스템은 패턴 보강 효율이 낮은 상황을 더 똑똑하고 빠르게 판단하여, 최적의 타이밍에 고급 에스컬레이션 파이프라인을 가동합니다.
